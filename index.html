<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ë§ ì˜ ë“£ëŠ” ì‹œë°”ê²¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #87CEEB; 
            font-family: sans-serif;
            touch-action: none; /* ì•„ì´íŒ¨ë“œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        #ui { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 20px; 
            background: rgba(0,0,0,0.3); 
            text-align: center; 
            z-index: 1000;
            box-sizing: border-box;
        }
        
        #status { 
            color: white; 
            font-size: 18px; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px #000; 
            margin-bottom: 15px;
            min-height: 25px;
        }
        
        button { 
            padding: 18px 35px; 
            font-size: 20px; 
            cursor: pointer; 
            border-radius: 30px; 
            border: none; 
            background: #FFD700; 
            font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            -webkit-appearance: none;
            transition: all 0.2s;
        }
        
        button:active { 
            background: #ffcc00; 
            transform: scale(0.95); 
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ë¡œë”© í‘œì‹œ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px #000;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">ì‹œë°”ê²¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="ui" style="display: none;">
        <div id="status">ì¤€ë¹„ ì™„ë£Œ! ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª…ë ¹í•˜ì„¸ìš”</div>
        <button id="start-btn">ğŸ¤ ëª…ë ¹í•˜ê¸°</button>
    </div>

    <script type="importmap">
        { 
            "imports": { 
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" 
            } 
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, mixer, controls, actions = {}, currentAction;
        let isRecognizing = false;
        const clock = new THREE.Clock();
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('start-btn');
        const loadingEl = document.getElementById('loading');

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(text) {
            statusEl.innerText = text;
            console.log(text);
        }

        // 1. ì¥ë©´ ë§Œë“¤ê¸°
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 50, 150);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // ì„±ëŠ¥ ìµœì í™”
        document.body.appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 20, 0);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.update();

        // ì¡°ëª… ê°œì„ 
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
        backLight.position.set(-5, 5, -5);
        scene.add(backLight);

        // 2. ì‹œë°”ê²¬ ë¶ˆëŸ¬ì˜¤ê¸°
        const loader = new GLTFLoader();
        loader.load(
            'shiba.glb',
            (gltf) => {
                const model = gltf.scene;
                
                // ëª¨ë¸ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì •
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                // ëª¨ë¸ì„ ì›ì ìœ¼ë¡œ ì´ë™
                model.position.sub(center);
                
                // ì ì ˆí•œ í¬ê¸°ë¡œ ìŠ¤ì¼€ì¼ë§ (í•„ìš”ì‹œ)
                const maxSize = Math.max(size.x, size.y, size.z);
                if (maxSize > 0) {
                    const scale = 50 / maxSize; // 50 ìœ ë‹› í¬ê¸°ë¡œ ì¡°ì •
                    model.scale.setScalar(scale);
                }
                
                scene.add(model);
                
                // ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
                if (gltf.animations && gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    
                    gltf.animations.forEach((clip) => {
                        const actionName = clip.name.toLowerCase();
                        actions[actionName] = mixer.clipAction(clip);
                        console.log('ì• ë‹ˆë©”ì´ì…˜ ë°œê²¬:', actionName);
                    });

                    // ê¸°ë³¸ ë™ì‘ ì‹œì‘
                    const defaultAction = actions['bounce'] || actions[Object.keys(actions)[0]];
                    if (defaultAction) {
                        currentAction = defaultAction;
                        currentAction.play();
                        console.log('ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ì¤‘');
                    }
                } else {
                    console.warn('ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
                }

                // UI í‘œì‹œ
                loadingEl.style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                updateStatus('ì¤€ë¹„ ì™„ë£Œ! ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª…ë ¹í•˜ì„¸ìš”');
                
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                animate();
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                loadingEl.innerText = `ì‹œë°”ê²¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ${percent}%`;
            },
            (error) => {
                console.error('ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:', error);
                loadingEl.innerText = 'âŒ ì‹œë°”ê²¬ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. shiba.glb íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.';
                loadingEl.style.color = '#ff6b6b';
            }
        );

        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            controls.update();
            renderer.render(scene, camera);
        }

        // ë™ì‘ ë°”ê¾¸ê¸° í•¨ìˆ˜ (ê°œì„ )
        function changeAction(name) {
            if (!actions) return;
            
            const next = actions[name.toLowerCase()];
            if (!next) {
                updateStatus(`"${name}" ë™ì‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
                console.warn('ì‚¬ìš© ê°€ëŠ¥í•œ ë™ì‘:', Object.keys(actions));
                return;
            }
            
            if (currentAction && currentAction !== next) {
                currentAction.fadeOut(0.3);
                next.reset().fadeIn(0.3).play();
                currentAction = next;
                updateStatus(`âœ“ ${name} ë™ì‘ ì‹¤í–‰!`);
            }
        }

        // 3. ìŒì„± ì¸ì‹ (ì•„ì´íŒ¨ë“œ ëŒ€ì‘)
        btn.onclick = () => {
            if (isRecognizing) return;
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                updateStatus('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            isRecognizing = true;
            btn.disabled = true;
            updateStatus('ğŸ¤ ë“£ëŠ” ì¤‘... (ë§í•´ë³´ì„¸ìš”)');

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                updateStatus(`ë“¤ì€ ë‚´ìš©: "${transcript}"`);
                
                // ëª…ë ¹ì–´ ë§¤ì¹­
                if (transcript.includes('attack')) changeAction('attack');
                else if (transcript.includes('bounce')) changeAction('bounce');
                else if (transcript.includes('eat')) changeAction('eat');
                else if (transcript.includes('click')) changeAction('clicked');
                else if (transcript.includes('fear') || transcript.includes('sit')) changeAction('fear');
                else {
                    updateStatus(`"${transcript}" - ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì…ë‹ˆë‹¤`);
                }
            };

            recognition.onerror = (event) => {
                console.error('ìŒì„±ì¸ì‹ ì˜¤ë¥˜:', event.error);
                if (event.error === 'no-speech') {
                    updateStatus('âš ï¸ ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                } else if (event.error === 'not-allowed') {
                    updateStatus('âŒ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
                } else {
                    updateStatus(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${event.error}`);
                }
                isRecognizing = false;
                btn.disabled = false;
            };

            recognition.onend = () => {
                isRecognizing = false;
                btn.disabled = false;
                setTimeout(() => {
                    if (statusEl.innerText.includes('ë“£ëŠ” ì¤‘')) {
                        updateStatus('ì¤€ë¹„ ì™„ë£Œ! ë‹¤ì‹œ ëª…ë ¹í•˜ì„¸ìš”');
                    }
                }, 2000);
            };
        };

        // í™”ë©´ í¬ê¸° ì¡°ì ˆ ëŒ€ì‘
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
